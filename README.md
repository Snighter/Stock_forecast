## 股票价格预测

### 0. 基本经济学知识

+ [有效市场假说](https://zh.wikipedia.org/zh-cn/%E6%95%88%E7%8E%87%E5%B8%82%E5%A0%B4%E5%81%87%E8%AA%AA)

弱式效率：目前股票价格已充分反映了过去股票价格所提供的各项情报。所以，投资人无法再运用各种方法对过去股票价格进行分析，再利用分析结果来预测未来股票价格，基于随机游走假说，未来消息是随机而来的。意即投资者无法再利用过去信息来获得超额回报。所以，弱式效率越高，若以过去价量为基础的技术分析来进行预测效应将会十分不准确。

目前也基本认为我国股市是弱式有效市场，是否为半强式存在争议。

在经济学界，股市是否有效是一个广泛讨论的话题，而**弱式有效市场假说**（Weak Form Efficiency Hypothesis, EMH）主张股市价格已经反映了所有历史价格信息。在这一假说下，基于历史价量数据的技术分析，如通过移动平均线、相对强弱指数（RSI）、布林带等方法进行股价预测，是无法系统性地超越市场的表现，也就是说，历史数据不能提供足够的信息来持续性地获得超额回报。因此，市场价格已被认为是“随机游走”的，未来的股价变化无法通过过去的数据预测。

然而，尽管弱式有效市场假说在一定程度上成立，但其并非完全无懈可击。实际上，股市的有效性是多层次的，还包括了**半强式**和**强式有效市场假说**。根据这些假设，技术分析可能在某些情况下失败，但利用公开的**财务信息**、**经济指标**（如GDP增长率、失业率等）、**政治事件**（如政策变化、美国选举、国际关系等）以及**内幕消息**，投资者仍然能够获得额外的超额利润。这些因素反映了市场信息的不完全性或反应滞后的特征，暗示在某些情境下，信息利用与分析可能会带来超额收益。

使用 $NLP$ 来处理各种信息有一定可能能够相对更好地进行预测股价，但受限于本次实验时间只进行根据过去价量的技术分析。

+ **预测目标的明确性**

  - **短期与长期预测**：短期股价预测（例如，几天的波动）往往受到更多噪声的影响，因此更难准确预测。相比之下，长期股价预测（例如，几个月或几年的趋势）可能更具可预测性。

  - **涨跌幅 vs. 绝对价格**：预测股价的绝对值（如未来某个时点的股价）较为困难，但预测股价的相对涨跌（如收益率或相对变化）相对更容易。

+ **突发事件**：如重大经济危机、自然灾害、公司丑闻等不可预测的事件可能对股票价格产生重大影响，这些事件是任何模型都难以预测的因素。

### 1. 数据收集与保存
- 使用 `baostock` API 获取股票和指数数据。
- 从指定文件或列表中读取股票代码（包括 si 和 st），并循环获取每只股票的相关数据。
- 将数据保存为 CSV 文件，存放在 `out/code_data` 文件夹中，保存所有股票代码列表。

### 2. 数据预处理
- 检查缺失值：`check_missing_values` 用于检查数据中的缺失值。
- 检查数据类型：`check_data_types` 用于确认数据列类型是否符合预期。
- 对日线数据（`*_d_data.csv`）和 15分钟数据（`*_15m_data.csv`）进行预处理，确保数据没有缺失且列类型正确。

### 3. 平稳性检验
- 使用 ADF（Augmented Dickey-Fuller）检验和 KPSS（Kwiatkowski-Phillips-Schmidt-Shin）检验来检查数据的平稳性。
+ 对每只股票的以下特征进行平稳性检验：
  - 日线数据：`open`，`close`，`pctChg`，`open_pctChg`
  - 15分钟数据：`open_diff`，`close_diff`
- 将平稳性检验结果（包括 ADF 和 KPSS 的统计值和 p-value）保存在 `results_d` 和 `results_15m` 列表中，并最终保存为 CSV 文件（`stationarity_results_d.csv` 和 `stationarity_results_15m.csv`）。
- 输出平稳性统计信息，展示每个变量在日线数据和15分钟数据中的平稳性检验结果。

### 4. 特征提取与训练模型
+ 从两个不同的数据集提取特征和预测目标：
  - 特征：`open`（开盘价），`close`（收盘价），`high`（最高价），`low`（最低价），`volume`（成交量），`amount`（成交额）。
  - 目标变量1：`pctChg`（收盘收益率）和 `open_pctChg`（开盘收益率）。
  - 目标变量2：`close_diff`（收盘差）和 `open_diff`（开盘差）。
- 使用随机森林基准模型来预测两个目标变量，提取并可视化特征重要性，帮助理解各个特征对预测的影响。

### 5. 数据归一化与准备
- 使用 `MinMaxScaler` 对数据进行归一化处理，确保数据在相同的尺度下。
- 构建适合用于 GRU 模型的数据集，转化为时间序列格式。

### 6. GRU 模型设计与训练
+ 设计 GRU 神经网络模型：
  - 模型包含三层 GRU 和 Dropout 层，旨在减少过拟合。
  - 对每个目标变量分别训练 GRU 模型，使用 Adam优化器和均方误差（MSE）作为损失函数。
+ 分别训练两个独立的 GRU 模型：
  - `model_open`：预测开盘价。
  - `model_close`：预测收盘价。

### 7. 未来预测
- 使用过去20天的数据（`n_steps=20`）进行未来5天的预测。
- 每次预测时，利用之前的预测结果作为输入，更新模型并进行多次迭代，逐步预测未来的开盘和收盘价格。
- 对预测的收益率进行反归一化，恢复成实际的开盘价和收盘价，并保存预测结果。

### 8. RMSE计算与评估
+ 训练完成后，使用 RMSE（均方根误差）评估模型预测结果的表现。
  - 将预测的收益率转化为实际价格，与真实数据进行对比，计算误差。
- 评估结果用于检查模型的精度，并调整模型参数。

### 9. 结果保存与文件输出
- 将每只股票的预测结果（包括日期、预测的开盘和收盘价格）保存到 CSV 文件中。
- 加权平均计算：对开盘价和收盘价的预测结果进行加权平均，70% 权重给日线预测，30% 权重给15分钟预测。
- 将加权平均结果保存到文件中，便于后续查看和分析。
